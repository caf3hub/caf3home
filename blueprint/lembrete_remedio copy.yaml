blueprint:
  name: Lembrete Rem√©dio
  description: Cria lembretes de rem√©dio em determinados hor√°rios.
  domain: automation
  input:
    notification_target:
      name: Servi√ßo de Notifica√ß√£o
      description: Servi√ßo de notifica√ß√£o que ir√° enviar a mensagem.
      selector:
        text:
    remedio_lista:
      name: Lista de Rem√©dios
      description: Insira os rem√©dios no formato --- Nome, Hor√°rio, Descri√ß√£o
      selector:
        text:
          multiline: true

triggers:
  - trigger: time_pattern
    minutes: /1

variables:
  remedio_lista: !input remedio_lista

action:
  - alias: Log da lista de rem√©dios
    service: system_log.write
    data:
      message: "Lista de Rem√©dios: {{ remedio_lista }}"
      level: info
      
  - alias: Log dos hor√°rios
    service: system_log.write
    data:
      message: "Hor√°rios: {{ horarios }}"
      level: info

  - alias: Preparar texto da notifica√ß√£o
    data:
      text: >-
        Por favor, gere um texto para uma notifica√ß√£o que ser√° enviada aos usu√°rios com informa√ß√µes sobre os rem√©dios a serem tomados.

        Voc√™ √© um assistente pessoal √∫til que gera texto para o usu√°rio:

        - Suas respostas s√£o √∫teis, amig√°veis e encorajadoras.
        - Suas mensagens devem ser claras e n√£o incluir termos t√©cnicos ou detalhes desnecess√°rios.
        - Liste os rem√©dios em t√≥picos para facilitar a leitura e compreens√£o.
        - Evite usar formata√ß√£o como negrito ou it√°lico, pois a mensagem ser√° enviada via Telegram.
        - Use emojis para adicionar um toque amig√°vel, como üíä para rem√©dios ou ‚è∞ para hor√°rios.
        - Inclua as seguintes informa√ß√µes sobre cada rem√©dio:
          - Nome do rem√©dio
          - Hor√°rio de tomar
          - Instru√ß√µes ou descri√ß√£o

        Rem√©dio para Agora:
        
        {%- set current_time = now().strftime('%H:%M') -%}
        {%- set remedio_encontrado = '' -%}
        {%- for remedio in remedio_lista.split('\n') -%}
          {%- set remedio_dados = remedio.split(', ') -%}
          {%- if remedio_dados | length > 1 and remedio_dados[1].strip() == current_time -%}
            {%- set remedio_encontrado = remedio -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if remedio_encontrado -%}
          {%- set remedio_dados = remedio_encontrado.split(', ') -%}
          - **Rem√©dio**: {{ remedio_dados[0].strip() }} üíä
            **Hor√°rio**: {{ remedio_dados[1].strip() }} ‚è∞
            **Instru√ß√£o**: {{ remedio_dados[2].strip() }}
        {%- else -%}
          N√£o h√° rem√©dios a serem tomados neste hor√°rio. 
        {%- endif -%}

      agent_id: conversation.google_generative_ai
    response_variable: agent
    action: conversation.process

  - alias: Enviar notifica√ß√£o
    service: !input notification_target
    data:
      title: "{{ now().strftime('%A') }} Lembrete de Rem√©dios"
      message: "{{ agent.response.speech.plain.speech }}"