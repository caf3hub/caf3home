blueprint:
  name: Lembrete Rem√©dio - Conversation AI
  description: Cria lembretes de rem√©dio em determinados hor√°rios.
  domain: automation
  input:
    notification_target:
      name: Servi√ßo de Notifica√ß√£o
      description: Servi√ßo de notifica√ß√£o que ir√° enviar a mensagem.
      default: "notify.mqtt_notify"
      selector:
        text:
    conversation:
      name: Servi√ßo de Conversation AI
      description: Servi√ßo de conversation ai que ir√° gerar a mensagem.
      default: "conversation.google_generative_ai"
      selector:
        text:
    remedio_lista:
      name: Lista de Rem√©dios
      description: Insira os rem√©dios no formato - Nome, HH:MM, Descri√ß√£o
      selector:
        text:
          multiline: true

variables:
  remedio_lista: !input remedio_lista

triggers:
  - topic: home/telegram/message/user
    id: remedio_tomado
    payload: remedio_tomado
    trigger: mqtt
    alias: Remedio tomado
  - topic: home/telegram/message/user
    id: remedio_pendente
    payload: remedio_pendente
    trigger: mqtt
    alias: Remedio Pendente
  - trigger: time_pattern
    minutes: /1
    id: hora_remedio
    alias: Hora remedio

action:
  - alias: Quando chega a hora do remedio
    if:
      - condition: trigger
        id:
          - hora_remedio
    then:
      - condition: template
        value_template: |-
          {% set horario_atual = now().strftime('%H:%M') %}
          {% set ns = namespace(horarios=[]) %}
          {% for remedio in remedio_lista.split('\n') %}
            {% set remedio_dados = remedio.split(', ') %}
            {% if remedio_dados | length > 1 %}
              {% set ns.horarios = ns.horarios + [remedio_dados[1].strip()] %}
            {% endif %}
          {% endfor %}
          {{ horario_atual in ns.horarios }}
      - action: conversation.process
        metadata: {}
        data:
          text: >
            O nome do seu mestre e pai √© Ruan, mas me chame de Mestre apenas.
            Voce vai enviar mensagens para o Telegram ou para Alexa. Varie o
            estilo da mensagem a cada vez que for gerada. N√£o quero sugest√µes,
            mande apenas uma mensagem. N√£o envie "\n" e nem tente fazer quebras
            de linha assim, nem nada disso pois nao funciona no telegram. Se for
            quebrar linhas apenas fa√ßa como se tivesse dando um enter e continue
            a digitar. Crie uma mensagem √∫nica e personalizada, de maneira
            criativa e variada, para informar que t√° na hora de tomar o rem√©dio.
            - Inclua as seguintes informa√ß√µes sobre os rem√©dios:
              - Nome do rem√©dio
              - Hor√°rio de tomar
              - Instru√ß√µes ou descri√ß√£o

            Rem√©dios para Agora:
            {%- set horario_atual = now().strftime('%H:%M') -%} {%- set remedios
            = remedio_lista.split('\n') -%} {%- set ns =
            namespace(encontrou=false)-%}
            {%- for remedio in remedios -%}
              {%- set remedio_dados = remedio.split(', ') -%}
              {%- if remedio_dados | length > 2 and remedio_dados[1].strip() == horario_atual -%}
                - **Rem√©dio**: {{ remedio_dados[0].strip() }} üíä  
                  **Hor√°rio**: {{ remedio_dados[1].strip() }} ‚è∞  
                  **Instru√ß√£o**: {{ remedio_dados[2].strip() }}  
                {%- set ns.encontrou = true -%}  {# Marca que encontrou um rem√©dio #}
              {%- endif -%}
            {%- endfor -%}
            {%- if not ns.encontrou -%}  {# Se nenhum rem√©dio foi encontrado #}
              Nenhum rem√©dio a ser tomado agora.
            {%- endif -%}
          agent_id: !input conversation
        response_variable: agent

  - alias: Se receber remedio_tomado no user
    if:
      - condition: trigger
        id:
          - remedio_tomado
    then:
      - service: !input notification_target
        data:
          message: >-
            √ìtimo trabalho! Voc√™ tomou o rem√©dio conforme o hor√°rio. Lembre-se
            de que manter o tratamento em dia √© importante para sua sa√∫de.

  - alias: Se receber remedio_pendente no user
    if:
      - condition: trigger
        id:
          - remedio_pendente
    then:
      - delay:
          hours: 0
          minutes: 20
          seconds: 0
          milliseconds: 0
      - action: conversation.process
        metadata: {}
        data:
          text: >-
            O nome do seu mestre e pai √© Ruan, mas me chame de Mestre apenas.
            Voc√™ vai enviar mensagens para o Telegram ou para Alexa. Varie o
            estilo da mensagem a cada vez que for gerada. N√£o quero sugest√µes,
            mande apenas uma mensagem. N√£o envie "\n" e nem tente fazer quebras
            de linha assim, nem nada disso pois n√£o funciona no Telegram. Se for
            quebrar linhas, apenas fa√ßa como se tivesse dando um enter e
            continue a digitar. Crie uma mensagem √∫nica e personalizada, de
            maneira criativa e variada, O usuario ainda n√£o tomou o remedio.
            responda com um lembrete gentil e encorajador, enfatizando a
            import√¢ncia de tomar o rem√©dio e oferecendo-se para lembrar
            novamente mais tarde.
          agent_id: !input conversation
        response_variable: agent

  - alias: Enviar notifica√ß√£o
    if:
      - condition: template
        value_template: "{{ agent is not none and agent.response.speech.plain.speech | length > 0 }}"
    then:
      - service: !input notification_target
        data:
          title: "{{ now().strftime('%A') }} Lembrete de Rem√©dios"
          message: "{{ agent.response.speech.plain.speech }}"

mode: parallel
max: 3