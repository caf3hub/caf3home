blueprint:
  name: Lembrete de Remédio com Entrada de Texto
  description: "Cria lembretes de remédios a partir de uma lista formatada manualmente com nome, horário e descrição."
  domain: automation
  input:
    notify_service:
      name: Serviço de notificação
      description: "Serviço de notificação para enviar o lembrete."
      default: "notify.mqtt_notify"
      selector:
        text: {}

    lembretes:
      name: Lembretes
      description: >
        Adicione os lembretes no formato:
        nome_remedio_1, HH:MM, descricao_remedio_1
        nome_remedio_2, HH:MM, descricao_remedio_2
      selector:
        text:
          multiline: true

trigger:
  - platform: time_pattern
    minutes: "/1"  # Verifica a cada minuto se há um lembrete

action:
  - variables:
      lembretes_raw: !input lembretes
      lembretes_lines: "{{ lembretes_raw.split('\n') }}"
      
  - repeat:
      count: "{{ lembretes_lines | length }}"
      sequence:
        - variables:
            lembrete: "{{ lembretes_lines[repeat.index] }}"
            parts: "{{ lembrete.split(',') }}"
        
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ parts | length == 3 and now().strftime('%H:%M') == parts[1].strip() }}"
              sequence:
                - service: "{{ notify_service }}"
                  data:
                    message: >
                      Lembrete de remédio: 
                      - Nome: {{ parts[0].strip() }}
                      - Horário: {{ parts[1].strip() }}
                      - Descrição: {{ parts[2].strip() }}
